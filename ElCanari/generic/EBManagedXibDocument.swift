//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
//  THIS FILE IS GENERATED BY EASY BINDINGS, DO NOT MODIFY IT
//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

import Cocoa

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
//  EBManagedXibDocument
//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

class EBManagedXibDocument : EBManagedDocument {

  //····················································································································
  //   Properties
  //····················································································································

  private final var mReadMetadataStatus : UInt8 = 0
  private final var mMetadataDictionary = [String : Any] ()
  private final var mSplashScreenWindow : EBWindow? = nil

  //····················································································································
  //    Document File Format
  //····················································································································

  final var mManagedDocumentFileFormat : EBManagedDocumentFileFormat = .binary {
    didSet {
      if self.mManagedDocumentFileFormat != oldValue {
        self.ebUndoManager.registerUndo (withTarget: self) { $0.mManagedDocumentFileFormat = oldValue }
      }
    }
  }

  //····················································································································
  //-  SAVE
  //····················································································································

  func metadataStatusForSaving () -> UInt8 {
    return 0
  }

  //····················································································································

  func saveMetadataDictionary (version : Int, metadataDictionary : inout [String : Any]) {
  }

  //····················································································································

  override func data (ofType typeName : String) throws -> Data {
  //--- Update document version
    var version = self.mVersion.propval
    switch self.mVersionShouldChangeObserver.selection {
    case .empty, .multiple :
      break
    case .single (let shouldChange) :
      if shouldChange {
        version += 1
        self.mVersion.setProp (version)
        self.mVersionShouldChangeObserver.updateStartUpSignature ()
      }
    }
  //--- Save metadata dictionary
    self.saveMetadataDictionary (version: version, metadataDictionary : &self.mMetadataDictionary)
  //--- Add the width and the height of main window to metadata dictionary
    if let unwrappedWindowForSheet = windowForSheet { // Document has been opened in the user interface
      if unwrappedWindowForSheet.styleMask.contains(.resizable) { // Only if window is resizable
        let windowSize = unwrappedWindowForSheet.frame.size ;
        self.mMetadataDictionary [WINDOW_WIDTH_METADATADICTIONARY_KEY] = windowSize.width
        self.mMetadataDictionary [WINDOW_HEIGHT_METADATADICTIONARY_KEY] = windowSize.height
      }
    }
  //---
    let documentData = EBDocumentData (
      documentMetadataStatus: self.metadataStatusForSaving (),
      documentMetadataDictionary: self.mMetadataDictionary,
      documentRootObject: self.mRootObject!,
      documentFileFormat: self.mManagedDocumentFileFormat
    )
    return try dataForSaveOperation (from: documentData)
  }

  //····················································································································
  //  Reachable objects from root object
  //····················································································································

  private func reachableObjectsFromRootObject () -> [EBManagedObject] {
    let rootObject = self.mRootObject!
    var reachableObjectArray = [rootObject]
    var reachableObjectSet = EBReferenceSet (rootObject)
    var objectsToExploreArray = [rootObject]
    while let objectToExplore = objectsToExploreArray.last {
      objectsToExploreArray.removeLast ()
      var accessible = [EBManagedObject] ()
      objectToExplore.accessibleObjects (objects: &accessible)
      for managedObject in accessible {
        if !reachableObjectSet.contains (managedObject) {
          reachableObjectSet.insert (managedObject)
          reachableObjectArray.append (managedObject)
          objectsToExploreArray.append (managedObject)
        }
      }
    }
    return reachableObjectArray
  }

  //····················································································································
  //    READ DOCUMENT FROM FILE
  //····················································································································

  override func read (from inData : Data, ofType typeName : String) throws {
  //--- Show "Opening xxx…" splash window ?
    if inData.count > 300_000 {
      let window = EBWindow (
        contentRect: NSRect (x: 0.0, y: 0.0, width: 450.0, height: 100.0),
        styleMask: [.titled],
        backing: .buffered,
        defer: true
      )
      self.mSplashScreenWindow = window
      window.title = "Opening " + self.displayName + "…"
      let vStackView = AutoLayoutVerticalStackView ()
      vStackView.appendView (AutoLayoutFlexibleSpace ())
      let hStackView = AutoLayoutHorizontalStackView ()
      hStackView.appendView (AutoLayoutFlexibleSpace ())
      hStackView.appendView (AutoLayoutSpinningProgressIndicator ())
      hStackView.appendView (AutoLayoutFlexibleSpace ())
      vStackView.appendView (hStackView)
      vStackView.appendView (AutoLayoutFlexibleSpace ())
      window.contentView = vStackView
      window.isReleasedWhenClosed = false
      window.center ()
      window.makeKeyAndOrderFront (nil)
      RunLoop.current.run (until: Date ())
    }

    self.ebUndoManager.disableUndoRegistration ()
  //--- Load file
    let startLoadFile = Date ()
    let documentData = try loadEasyBindingFile (fromData: inData, documentName: self.displayName, undoManager: self.ebUndoManager)
    self.mManagedDocumentFileFormat = documentData.documentFileFormat
    if LOG_OPERATION_DURATION {
      Swift.print ("Load File \(Date ().timeIntervalSince (startLoadFile) * 1000.0) ms, format \(documentData.documentFileFormat.string)")
    }
  //--- Store Status
    self.mReadMetadataStatus = documentData.documentMetadataStatus
  //--- Store metadata dictionary
    self.mMetadataDictionary = documentData.documentMetadataDictionary
  //--- Read version from file
    self.mVersion.setProp (self.readVersionFromMetadataDictionary (documentData.documentMetadataDictionary))
  //--- Remove current root object graph
    for object in self.reachableObjectsFromRootObject () {
      object.cleanUpRelationshipsAndRemoveAllObservers ()
    }
  //--- Store root object
    self.mRootObject = documentData.documentRootObject
  //---
    self.ebUndoManager.enableUndoRegistration ()
  }

  //····················································································································

  func readVersionFromMetadataDictionary (_ metadataDictionary : [String : Any]) -> Int {
    return 0
  }

  //····················································································································
  //   showWindows
  //····················································································································

  override final func showWindows () {
    super.showWindows ()
    if let unwrappedWindowForSheet = self.windowForSheet, // Document has been opened in the user interface
          unwrappedWindowForSheet.styleMask.contains (.resizable), // Only if window is resizable
          let windowWidth = self.mMetadataDictionary [WINDOW_WIDTH_METADATADICTIONARY_KEY] as? CGFloat,
          let windowHeight = self.mMetadataDictionary [WINDOW_HEIGHT_METADATADICTIONARY_KEY] as? CGFloat {
      let newSize = NSSize (width: windowWidth, height: windowHeight)
      var windowFrame : NSRect = unwrappedWindowForSheet.frame
      windowFrame.size = newSize
      if let visibleFrame = unwrappedWindowForSheet.screen?.visibleFrame {
        if windowFrame.size.width > visibleFrame.size.width {
          windowFrame.size.width = visibleFrame.size.width
        }
        if windowFrame.size.height > visibleFrame.size.height {
          windowFrame.size.height = visibleFrame.size.height
        }
        if windowFrame.origin.x < visibleFrame.origin.x {
          windowFrame.origin.x = visibleFrame.origin.x
        }
        if windowFrame.origin.y < visibleFrame.origin.y {
          windowFrame.origin.y = visibleFrame.origin.y
        }
        if windowFrame.maxX > visibleFrame.maxX {
          windowFrame.origin.x -= windowFrame.maxX - visibleFrame.maxX
        }
        if windowFrame.maxY > visibleFrame.maxY {
          windowFrame.origin.y -= windowFrame.maxY - visibleFrame.maxY
        }
      }
      unwrappedWindowForSheet.setFrame (windowFrame, display: true)
    }
    flushOutletEvents ()
    if let window = self.mSplashScreenWindow {
      window.orderOut (nil)
      self.mSplashScreenWindow = nil
    }
  }

  //····················································································································
  //   showObjectExplorerWindow:
  //····················································································································

  #if BUILD_OBJECT_EXPLORER
    @IBAction func showObjectExplorerWindow (_ : AnyObject) {
      if mDocumentExplorerWindow == nil {
        self.createAndPopulateObjectExplorerWindow ()
      }
      self.mDocumentExplorerWindow?.makeKeyAndOrderFront (nil)
    }
  #endif

  //····················································································································
  //   createAndPopulateObjectExplorerWindow
  //····················································································································

  #if BUILD_OBJECT_EXPLORER
    func createAndPopulateObjectExplorerWindow () {
    //-------------------------------------------------- Create Window
      let r = NSRect (x: 20.0, y: 20.0, width: 10.0, height: 10.0)
      self.mDocumentExplorerWindow = NSWindow (
        contentRect: r,
        styleMask: [.titled, .closable],
        backing: .buffered,
        defer: true,
        screen: nil
      )
    //-------------------------------------------------- Adding properties
      let view = NSView (frame: r)
      var y : CGFloat = 0.0
      self.populateExplorerWindow (&y, view: view)
    //-------------------------------------------------- Finish Window construction
    //--- Resize View
      let viewFrame = NSRect (x: 0.0, y: 0.0, width: EXPLORER_ROW_WIDTH, height: y)
      view.frame = viewFrame
    //--- Set content size
      self.mDocumentExplorerWindow?.setContentSize (NSSize (width: EXPLORER_ROW_WIDTH + 16.0, height: fmin (600.0, y)))
    //--- Set close button as 'remove window' button
      let closeButton = self.mDocumentExplorerWindow?.standardWindowButton (.closeButton)
      closeButton?.target = self
      closeButton?.action = #selector(Self.deleteDocumentWindowAction(_:))
    //--- Set window title
      self.mDocumentExplorerWindow?.title = "Document " + className
    //--- Add Scroll view
      let frame = NSRect (x: 0.0, y: 0.0, width: EXPLORER_ROW_WIDTH, height: y)
      let sw = NSScrollView (frame: frame)
      sw.hasVerticalScroller = true
      sw.documentView = view
      self.mDocumentExplorerWindow?.contentView = sw
    }
  #endif

  //····················································································································
  //   deleteDocumentWindowAction
  //····················································································································

  #if BUILD_OBJECT_EXPLORER
    @objc func deleteDocumentWindowAction (_ : Any) {
      self.clearObjectExplorer ()
    }
  #endif

  //····················································································································
  //   clearObjectExplorer
  //····················································································································

  #if BUILD_OBJECT_EXPLORER
    func clearObjectExplorer () {
      let closeButton = mDocumentExplorerWindow?.standardWindowButton (.closeButton)
      closeButton?.target = nil
      self.mDocumentExplorerWindow?.orderOut (nil)
      self.mDocumentExplorerWindow = nil
      self.mAccessibleObjectsExplorerPopUpButton = nil
      self.mRootObjectExplorerButton = nil
    }
  #endif

  //····················································································································
  //    populateExplorerWindow
  //····················································································································

  #if BUILD_OBJECT_EXPLORER
    final var mDocumentExplorerWindow : NSWindow? = nil
  #endif

  #if BUILD_OBJECT_EXPLORER
    final var mAccessibleObjectsExplorerPopUpButton : NSPopUpButton? = nil
  #endif

  #if BUILD_OBJECT_EXPLORER
    final var mRootObjectExplorerButton : NSButton? = nil {
      didSet {
        if let valueExplorer = self.mRootObjectExplorerButton {
          updateManagedObjectToOneRelationshipDisplay (object: self.mRootObject, button: valueExplorer)
        }
      }
    }
  #endif

  //····················································································································

  #if BUILD_OBJECT_EXPLORER
    func populateExplorerWindow (_ y : inout CGFloat, view : NSView) {
      if let rootObject = self.mRootObject {
        createEntryForToOneRelationshipNamed (
          "Root",
          object: rootObject,
          y: &y,
          view: view,
          valueExplorer: &self.mRootObjectExplorerButton
        )
        createEntryForToManyRelationshipNamed (
          "Entities",
          object: rootObject,
          y: &y,
          view: view,
          valueExplorer: &self.mAccessibleObjectsExplorerPopUpButton
        )
      }
    }
  #endif

  //····················································································································

  #if BUILD_OBJECT_EXPLORER
    func updateReachableEntitiesPopUpButton () {
      if let accessibleObjectsExplorerPopUpButton = self.mAccessibleObjectsExplorerPopUpButton {
        let selectedObjects = reachableObjectsFromRootObject ()
        updateManagedObjectToManyRelationshipDisplay (objectArray: selectedObjects, popUpButton: accessibleObjectsExplorerPopUpButton)
      }
    }
  #endif

  //····················································································································
  //    windowControllerDidLoadNib
  //····················································································································

  override func windowControllerDidLoadNib (_ aController : NSWindowController) {
    super.windowControllerDidLoadNib (aController)
  //--- Signature observer
    self.mRootObject?.setSignatureObserver (observer: self.mSignatureObserver)
    self.mSignatureObserver.setRootObject (self.mRootObject!)
  //--- Version did change observer
    self.mVersionShouldChangeObserver.setSignatureObserverAndUndoManager (self.mSignatureObserver, self.ebUndoManager)
    self.mSignatureObserver.addEBObserver (self.mVersionShouldChangeObserver)
  }

  //····················································································································
  //   removeWindowController
  //····················································································································

  func removeUserInterface () {
    self.mSignatureObserver.removeEBObserver (self.mVersionShouldChangeObserver)
    #if BUILD_OBJECT_EXPLORER
      self.clearObjectExplorer ()
    #endif
  }

  //····················································································································

  override final func removeWindowController (_ inWindowController : NSWindowController) {
  //--- Remove user interface
    self.removeUserInterface ()
  //--- Remove all entities
    let start = Date ()
    let allEntities = self.reachableObjectsFromRootObject ()
    if LOG_OPERATION_DURATION {
      Swift.print ("  Reachable objects \(Int (Date ().timeIntervalSince (start) * 1000.0)) ms")
    }
    #if BUILD_OBJECT_EXPLORER
      for entity in allEntities {
        entity.clearObjectExplorer ()
      }
    #endif
    for entity in allEntities {
      entity.removeAllObservers ()
    }
    for entity in allEntities {
      entity.cleanUpToManyRelationships ()
    }
    for entity in allEntities {
      entity.cleanUpToOneRelationships ()
    }
    if LOG_OPERATION_DURATION {
      Swift.print ("  Clean objects \(Int (Date ().timeIntervalSince (start) * 1000.0)) ms")
    }
  //---
    super.removeWindowController (inWindowController)
  }

  //····················································································································
  //    Signature observer
  //····················································································································

  private var mSignatureObserver = EBSignatureObserverEvent ()

  //····················································································································

  var signatureObserver_property : EBSignatureObserverEvent { return self.mSignatureObserver }

  //····················································································································
  //    Version
  //····················································································································

  private var mVersion = EBStoredProperty_Int (defaultValue: 0, undoManager: nil)

  //····················································································································

  var versionObserver_property : EBStoredProperty_Int { return self.mVersion }

  //····················································································································
  //    Version observer
  //····················································································································

  private var mVersionShouldChangeObserver = EBVersionShouldChangeObserver ()

  //····················································································································

  var versionShouldChangeObserver_property : EBVersionShouldChangeObserver {
    return self.mVersionShouldChangeObserver
  }

  //····················································································································
  //    Reset version and signature
  //····················································································································

  func resetVersionAndSignature () {
    self.ebUndoManager.registerUndo (
      withTarget: self,
      selector: #selector (performUndoVersionNumber(_:)),
      object: NSNumber (value: self.mVersion.propval)
    )
    self.mVersion.setProp (0)
    self.mVersionShouldChangeObserver.clearStartUpSignature ()
  }

  //····················································································································

  @objc func performUndoVersionNumber (_ oldValue : NSNumber) {
    self.ebUndoManager.registerUndo (
      withTarget: self,
      selector: #selector (performUndoVersionNumber(_:)),
      object: NSNumber (value: self.mVersion.propval)
    )
    self.mVersion.setProp (oldValue.intValue)
  }

  //····················································································································
  // Menu Events
  //····················································································································

  override func validateMenuItem (_ inMenuItem : NSMenuItem) -> Bool {
    let validate : Bool
    let action = inMenuItem.action
    if action == #selector (Self.printDocument(_:)) {
      validate = self.windowForSheet?.firstResponder is EBGraphicView
    }else if action == #selector (Self.setBinaryFormatAction(_:)) {
      validate = true
      inMenuItem.state = (self.mManagedDocumentFileFormat == .binary) ? .on : .off
    }else if action == #selector (Self.setTextualFormatAction(_:)) {
      validate = true
      inMenuItem.state = (self.mManagedDocumentFileFormat == .textual) ? .on : .off
    }else{
      validate = super.validateMenuItem (inMenuItem)
    }
    // NSLog ("VALIDATE \(action) -> \(validate)")
    return validate
  }

  //····················································································································
  //   FORMAT ACTIONS
  //····················································································································

  @IBAction func setBinaryFormatAction (_ inSender : Any?) {
    self.mManagedDocumentFileFormat = .binary
  }

  //····················································································································

  @IBAction func setTextualFormatAction (_ inSender : Any?) {
    self.mManagedDocumentFileFormat = .textual
  }

  //····················································································································
  //   PRINT
  //····················································································································

  @objc override func printDocument (_ inSender : Any?) {
    if let view = self.windowForSheet?.firstResponder as? EBGraphicView {
      let printOperation = NSPrintOperation (view: view, printInfo: self.printInfo)
      let printPanel = printOperation.printPanel
      printPanel.options = [printPanel.options, .showsPaperSize, .showsOrientation, .showsScaling]
      self.runModalPrintOperation (printOperation, delegate: nil, didRun: nil, contextInfo: nil)
    }
  }

  //····················································································································

}

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
//  EBVersionShouldChangeObserver
//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

final class EBVersionShouldChangeObserver : EBTransientProperty_Bool, EBSignatureObserverProtocol {

  //····················································································································

  private weak var mUndoManager : EBUndoManager? = nil // SOULD BE WEAK
  private weak var mSignatureObserver : EBSignatureObserverEvent? = nil // SOULD BE WEAK
  private var mSignatureAtStartUp : UInt32 = 0

  //····················································································································

  override init () {
    super.init ()
    self.mReadModelFunction = { [weak self] in
      if let unwSelf = self {
        return .single (unwSelf.mSignatureAtStartUp != unwSelf.signature ())
      }else{
        return .empty
      }
    }
  }

  //····················································································································

  final func setSignatureObserverAndUndoManager (_ signatureObserver : EBSignatureObserverEvent, _ ebUndoManager : EBUndoManager?) {
    self.mUndoManager = ebUndoManager
    self.mSignatureObserver = signatureObserver
    self.mSignatureAtStartUp = signatureObserver.signature ()
  }

  //····················································································································

  final func updateStartUpSignature () {
    if let signatureObserver = self.mSignatureObserver {
      self.mSignatureAtStartUp = signatureObserver.signature ()
      self.observedObjectDidChange ()
    }
  }

  //····················································································································

  func signature () -> UInt32 {
    if let signatureObserver = self.mSignatureObserver {
      return signatureObserver.signature ()
    }else{
      return 0
    }
  }

  //····················································································································

  func clearSignatureCache () {
    self.observedObjectDidChange ()
  }

  //····················································································································
  // clearStartUpSignature
  //····················································································································

  func clearStartUpSignature () {
    self.mUndoManager?.registerUndo (withTarget: self, selector:#selector (performUndo(_:)), object:NSNumber (value: mSignatureAtStartUp))
    self.mSignatureAtStartUp = 0
    self.observedObjectDidChange ()
  }

  //····················································································································

  @objc func performUndo (_ oldValue : NSNumber) {
    self.mUndoManager?.registerUndo (withTarget: self, selector:#selector (performUndo(_:)), object:NSNumber (value: mSignatureAtStartUp))
    self.mSignatureAtStartUp = oldValue.uint32Value
    self.observedObjectDidChange ()
  }

  //····················································································································

}

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————

func appendShowExploreDocumentWindowMenuItem (_ inMenu : NSMenu) {
  #if BUILD_OBJECT_EXPLORER
    let menuItem = NSMenuItem (
      title: "Explore document",
      action: #selector (EBManagedXibDocument.showObjectExplorerWindow (_:)),
      keyEquivalent: ""
    )
    menuItem.keyEquivalentModifierMask = [.command, .control]
    inMenu.addItem (menuItem)
  #endif
}

//——————————————————————————————————————————————————————————————————————————————————————————————————————————————————————
